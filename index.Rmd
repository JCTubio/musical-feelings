---
title: "Happiness perception vs Valence"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    storyboard: true
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(car)
library(gvlma)
library(plotly)
library(gvlma)
music_ds <- readxl::read_excel('Music_ds.xlsx')

#Select only participants who finished the questionnaire with no problems
cln_music <- music_ds%>%
  subset(Status==0 & Finished == 1)

#Select only participants that took more than 4 minutes to do the questionnaire
cln_music <- cln_music%>%
  subset(`Duration (in seconds)`>240)

#Dataset with important variables
stats_ds <- cln_music%>%
  select(-c(Status:RecordedDate),-Q21)

#Change var names to delete spaces
colnames(stats_ds)[2:16] <- tolower(gsub('g ','g',colnames(stats_ds)[2:16]))

###Change the order of Song_n scores so higher score = happier song###

my_fun <- function(x){8-x}
new_cols<- t(apply(stats_ds[,2:16],1,my_fun))

stats_ds <- cbind(stats_ds,new_cols)

stats_ds <- stats_ds%>%
  select(-(2:16))

## hypothesis 1
#get songs valence
vlncs <- data.frame(song = colnames(stats_ds)[20:34], valence = c(0.934,0.892,0.88,0.736,0.598,0.537,0.418,0.262,0.637,0.109,0.130,0.403,0.473,0.531,0.354))

#get songs names
song_names <- data.frame(id = colnames(stats_ds)[20:34], name = c("cold heart – pnau remix", "industry baby (feat. jack harlow)", "ibiza", "amsterdam", "le bled", "bad habits", "hard to say goodbye", "where are you now", "do it do it", "moth to a flame (with the weeknd)", "easy on me", "thunder", "ghost", "heat waves", "remember (and david guetta)"), valence = c(0.934,0.892,0.88,0.736,0.598,0.537,0.418,0.262,0.637,0.109,0.130,0.403,0.473,0.531,0.354))

  #put data in the right format
reg_ds <- stats_ds%>%
  pivot_longer(song1:song15)%>%
  select(song = name, hppy = value,ResponseId)%>%
  inner_join(vlncs)

part <- unique(reg_ds$ResponseId)
songs <- unique(reg_ds$song)
stand_ds <- data.frame(song = NA, hppy = NA, valence = NA, scaled_valence = NA, z_hppy = NA, ResponseId = NA)

for(i in 1:length(part)){
  this_part <- reg_ds%>%
    subset(ResponseId == part[i])%>%
    mutate(z_hppy = (hppy-mean(hppy))/sd(hppy))%>%
    mutate(scaled_valence = valence * 7) #Since valence is measured in a 0-1 scale, multiplying it by 7 we can compare the values with perceived happiness easily
  stand_ds <- stand_ds%>%
    add_row(this_part)
  ifelse(i == length(part),stand_ds <- stand_ds[-1,],NA)
#fit the model just so i can check the assumptions
fit <- lm(valence ~ z_hppy,stand_ds)

## hypothesis 2
#get sophistication scores
sphst <- stats_ds%>%
  select(ResponseId,Q16_1:Q19)%>%
  mutate(Q16_7 = 8 - Q16_7)%>% #correcting the contraindicative items
  mutate(Q16_9 = 8 - Q16_9)%>%
  mutate(Q16_11 = 8 - Q16_11)%>%
  mutate(Q16_13 = 8 - Q16_13)%>%
  mutate(Q16_14 = 8 - Q16_14)
sphst <- sphst%>%
  mutate(sophi = rowSums(sphst[,2:19]))%>%
  select(ResponseId,sophi)
  
  #get dataset 
mod_ds <- stats_ds%>%
  pivot_longer(song1:song15)%>%
  select(ResponseId,song = name, hppy = value)%>%
  inner_join(vlncs)%>%
  inner_join(sphst)%>%
  select(-hppy,-valence)%>%
  inner_join(stand_ds, by = c('song','ResponseId'))

 #fit model to check assumption
X <- mod_ds$hppy
Z <- mod_ds$sophi
Y <- mod_ds$valence
X <- c(scale(X, center = T, scale = F))
sophistication <- c(scale(Z, center = T, scale = F))
library(gvlma)
fitMod <- lm(Y ~ X + sophistication + X*sophistication) 
}
## hypothesis 3
#make the three different sophistication groups
low <- sort(sphst$sophi)[1:(length(sphst$sophi)*(1/3))]
mid <- sort(sphst$sophi)[(length(sphst$sophi)*(1/3)+1):(length(sphst$sophi)*(2/3))]
high <- sort(sphst$sophi)[(length(sphst$sophi)*(2/3)+1):(length(sphst$sophi))]

#make data set 
var_ds <- stats_ds%>%
  pivot_longer(song1:song15)%>%
  select(ResponseId,song = name, hppy = value)%>%
  inner_join(vlncs)%>%
  inner_join(sphst)%>%
  mutate(grp = ifelse(sophi %in% low, 1,2))%>%
  mutate(grp = ifelse(sophi %in% high,3,grp))%>%
  mutate(grp = as.factor(grp))
```

Background {data-orientation=columns}
=======================================================================

Column
-----------------------------------------------------------------------

### Hypothesis 1: Perceived happiness can predict songs valence {data-height=1200}
```{r}
reg_ds%>% 
  ggplot(aes(factor(hppy), valence))+ 
  geom_boxplot(fill = '#1DB954')+
  xlab('Happiness rating')+
  ylab('Song valence')+
  labs(title = 'Songs rated as happier tend to have a higher valence',
       subtitle = 'Distribution of valences for songs rated at different happiness level')+
  theme_minimal()+
  theme(plot.title = element_text(face = 2),
        panel.grid.major.x = element_blank())
```

### Introduction
The demand for music has grown to become an important aspect of many peoples’ everyday life (Fuentes et al., 2019). Especially, the mode of music listening has shifted from only actively listening to music from time to time, to the soundtracking of daily activities. People accompany various activities with music, and it becomes an affective-practical resource. Songs have shown to change and strengthen peoples’ emotions, help patients’ with their anxiety and improve workers’ concentration (Sloboda et al., 2001; Mok & Wong, 2003; Lesiuk, 2005).
A high demand for music automatically leads to a high demand for research in music listening behaviour. Several studies have focused on Music Emotion Recognition (MER) (Aljanaki et al. 2014). It focuses mostly on two dimensions: “valence (positive vs. negative) and arousal (quiet vs. energetic). However, the perfect MER model has not yet been found. 


### Research Question
This study will try to understand the measurement of valence and whether subjective and objective valence differs as much in our sample. Additionally, many studies have shown that musical sophistication has an effect on the relationship between objective and subjective musical perception (REF). We will examine whether the level of expertise in music will impact musical perception in the context of valence, leading to the following research question:

**To what extent does objective valence judgement predict subjective happiness ratings and to what extent is this relationship moderated by music sophistication?**

Column
-----------------------------------------------------------------------

### Playlist {data-height=790}
```{r}
knitr::kable(song_names)
```

### Data cleaning {data-height=270}
The original data set contained 103 responses, but some had to be dropped. 
21 participants did not finish the questionnaire and were thus removed from the data set. Furthermore, four participants took less than four minutes to complete the questionnaire. 
This was considered unreasonably low and so these responses were also removed from the data set. After this cleaning process, the data set contained 78 responses.

### Method {data-height=290}
In accordance with the hypotheses, the measured variables were participant’s happiness ratings per song (DV), Spotify’s valence ratings per song (IV) and the participants’ respective levels of musical sophistication (IV / Moderator).
A convenience sample was gathered by distributing the questionnaire to friends, family, colleagues and other students.
The valence ratings were sourced from the web-version of the Spotify API. The remaining, participant-specific data was gathered through Qualtrics using a mixed design. After signing the informed consent, participants were first asked to judge the happiness of 15 songs which were selected from the Dutch Charts playlist on Spotify. The songs were selected in a manner so that the spectrum from very low to very high valence (Spotify API) was completely covered. Following this, the participants were asked to fill out the Goldsmith Musical Sophistication Index (Gold-MSI) questionnaire, specifically the 18 items measuring the general musical sophistication subscale. For each item, participants are asked to indicate their agreement to the given statement on a scale from “Completely Disagree” to “Completely Agree”. Example items include “I can sing and play music from my memory” and “I would not consider myself a musician” (reverse-coded). 


Hypothesis 1
=======================================================================

Row {data-height=650}
-------------------------------------

### Hypothesis: Perceived happiness can predict songs valence
    
```{r}
reg_ds%>% 
  ggplot(aes(factor(hppy), valence))+ 
  geom_boxplot(fill = '#1DB954')+
  xlab('Happiness rating')+
  ylab('Song valence')+
  labs(title = 'Songs rated as happier tend to have a higher valence',
       subtitle = 'Distribution of valences for songs rated at different happiness level')+
  theme_minimal()+
  theme(plot.title = element_text(face = 2),
        panel.grid.major.x = element_blank())
```

Row {.tabset .tabset-fade}
-------------------------------------

### Resid
```{r, results='hide'}
#norality of the residuals
qqPlot(fit)
```

### homoscedasticity
```{r}
#homoscedasticity
plot(fitted(fit),resid(fit))
lines(c(0.34,0.7),c(0,0), lty = 2,lwd = 2)
```

### Sensitivity
```{r}
#sensitivity
plot(hatvalues(fit))
```

### Fitting the model
The model seems to fit adequately well. 
Both the intercept and the slope coefficients are significant and the R2 = 0.1211. This can be interpreted as happiness score being able to explain 12% of the variance in the song's valence. 
```{r}
fit <- lm(valence ~ z_hppy,stand_ds)
summary(fit)
```

 
Column {.sidebar data-width=300}
-------------------------------------

### Rationale
Spotify offers 12 APIs that are known as successful measures of musical characteristics in songs (Panda et al.,2021). Valence is one of them, and it describes the level of positivity a song has. As Spotify is a world-wide leading music streaming service with a lot of access to consumer behaviour, its measures of valence are argued to be objective measures capable of predicting consumers’ subjective ratings of a song's positivity and happiness.

### Testing the hypothesis
In order to check this prediction, we will perform a simple linear regression in which we try to predict the valence of the song, given the participant's happiness rating. 

### Repeated measures 
Because each participant gave a happiness score for each of the 15 scores, our data set contains what we call 'repeated measures'. Participants may have a tendency to rank songs as being happier or as being sadder, making some of the variance in the happiness scores due to the participant's biases. We want to take this variance out of the analysis and to do so we standardize answers within each participant. Now each participant's answer is a z-score, implying that all participants have a mean answer of 0, and the standard deviation of their answers is 1. There is no more variance due to personal biases!

### Checking the assumptions
Before performing any regressions it is important to check that the data does not violate any of the core assumptions of the analysis. Both of the assumptions were clearly met: there were no significant outliers and the errors were almost normally distributed. The homoscedasticity assumptions was less clearly met, but the violation was considered too subtle to mean any problem for the analysis. 

Hypothesis 2
=======================================================================

Row {.tabset data-height=650}
-------------------------------------

### Hypothesis: The relationship between happiness and valence is moderated by music sophistication
    
```{r}


low <- sort(sphst$sophi)[1:(length(sphst$sophi)*(1/3))]
mid <- sort(sphst$sophi)[(length(sphst$sophi)*(1/3)+1):(length(sphst$sophi)*(2/3))]
high <- sort(sphst$sophi)[(length(sphst$sophi)*(2/3)+1):(length(sphst$sophi))]

#make data set 
plot_ds <- stats_ds%>%
  pivot_longer(song1:song15)%>%
  select(ResponseId,song = name, hppy = value)%>%
  inner_join(vlncs)%>%
  inner_join(sphst)%>%
  mutate(grp = ifelse(sophi %in% low, 1,2))%>%
  mutate(grp = ifelse(sophi %in% high,3,grp))%>%
  mutate(grp = as.factor(grp))

levels(plot_ds$grp) <- c('Low','Mid','High')

ggplot(plot_ds,aes(x=factor(hppy),y=valence,fill = grp))+
  geom_boxplot()+
  facet_grid(.~grp)+
  xlab(label = 'Happiness scores')+
  ylab(label = ifelse(i == 1,'Valence',''))+
  theme_minimal()+
  theme(plot.title = element_text(face="bold"))+
  theme(legend.position =  'none',
        panel.grid.major.x = element_blank())+
  scale_fill_manual(values = c('Low' = "#c5f6d6",'Mid' = "#83eca7",'High' = "#1db954"))+
  labs(title = 'Sophistication has no moderation effect', subtitle = 'Valence distributions at each level of happiness by sophistication levels')
```
 
Column {.sidebar data-width=300}
-------------------------------------

### Rationale
As mentioned before, research has shown that musically sophisticated people rate musical characteristics more similar to objective, music-theory based measures, than people who are less involved in making or listening to music (Castro & Lima, 2014).

### Setup
To check this prediction we perform a moderation analysis. We keep the standardized version of the happiness scores because of the same reasons exposed in the simple linear regression. 

### Checking extra assumptions
Performing a moderation analysis implies entering the domains of the multiple linear regression (i.e. now there os more than one predictor). This means that the multicollinearity between predictors must be checked. To do so we look at the VIF values of the two predictors used, and there seems to be no multicollinearity at all.

### Fitting the model
The model points at the interaction term being not significant and R2 = 0.1043. This points at our prediction not being met: the interaction is not significant and including this interaction term into the regression 

```{r, results='hide'}
    #Center data (this is not the same as the standardization process we did before)
X <- mod_ds$hppy
Z <- mod_ds$sophi
Y <- mod_ds$valence

X <- c(scale(X, center = T, scale = F))
sophistication <- c(scale(Z, center = T, scale = F))

    #Fit model
library(gvlma)
fitMod <- lm(Y ~ X + sophistication + X*sophistication) 
summary(fitMod)
```


### Analysis and conclusion
Although the fit statistics already point at our prediction being not supported by the data, we can explore it visually. To do so we plot the valence distribution of songs at each level of happiness, for three different sophistication levels. If there was a moderation effect we would expect the direction of the relationship to change significantly in at least one of the three sophistication levels. Nevertheless, in all three plots, the relationship between valence and happiness seems identical.

Hypothesis 3
=======================================================================

Row {.tabset data-height=650}
-------------------------------------

### Hypothesis: The variance in perceived happiness scores is lower among highly sophisticated participants
```{r}
#calculate levene's test and make plots

songs <- unique(var_ds$song)
plot <- list()

for(i in 1:15){
  song <- var_ds%>%
    subset(song == songs[i])
  lev_p <- p.adjust(car::leveneTest(song$hppy,song$grp)$`Pr(>F)`[1],'bonferroni',15) #we correct for multiple testing
  plot[[i]] <- ggplot(song,aes(grp,hppy,fill = grp))+
    geom_boxplot()+  
    ggtitle(paste(c('   Song ',i),collapse = ''))+
    scale_x_discrete(labels = c('low','mid','high'))+
    xlab(ifelse(i %in% 11:15,'sophistication',''))+
    ylab(ifelse(i %in% c(1,6,11),'happiness',''))+
    theme(plot.title = element_text(face="bold"))+
    scale_fill_manual(values = c('1' = "#c5f6d6",
                                 '2' = "#83eca7",
                                 '3' = "#1db954"))+
    theme_minimal()+
    theme(legend.position = 'none')+
    scale_y_continuous(breaks = seq(1,7,by = 1))+
    ylim(1,7)
  }

gridExtra::grid.arrange(plot[[1]],plot[[2]],plot[[3]],plot[[4]],plot[[5]],plot[[6]],plot[[7]],
                        plot[[8]],plot[[9]],plot[[10]],plot[[11]],plot[[12]],plot[[13]],
                        plot[[14]],plot[[15]],nrow = 3)
```

### Sophistication spread
```{r}
frm_ppr <- data.frame(dens = msm::rtnorm(5000,81.50,20.6,18,126),grp = rep(2,500))

var_ds%>%
  select(ResponseId,sophi,grp)%>%
  mutate(grp = 1)%>%
  unique()%>%
  ggplot(aes(x = sophi,fill = factor(grp)))+
  geom_histogram(aes(y = ..density..),color = 'black',binwidth = 7,center =3.5)+
  geom_density(frm_ppr,mapping = aes(x = dens,fill = factor(grp)),alpha = 0.4,color = 'black')+
  scale_fill_manual(values = c('1' = "#90ee90",
                               '2' = '#ededed'),
                    labels = c('Our data','Previous data'))+
  labs(title = 'Sample sophistication scores spreaded enough',
       subtitle = 'Distribution of sophistication scores, our sample vs original research',
       fill = 'Data set')+
  xlab('Sophistication')+
  ylab('Density')+
  theme_minimal()+
  scale_x_continuous(limits = c(10,140),breaks = seq(20,130,10))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.title.x = element_text(margin = margin(t=5)),
        axis.title.y = element_text(margin = margin(r=10)),
        text = element_text(size = 14),
        plot.title = element_text(face = 2, hjust = 0.3),
        plot.subtitle = element_text(hjust = 0.3))
```

Column {.sidebar data-width=300}
-------------------------------------

### Rationale
The better understanding of music of more sophisticated people indicates that ‘music experts’ are not only better at rating sound characteristics, but that their answers were more align as they based their decision on music-theory (Castro & Lima, 2014).

### Levene's test
To check this prediction we use the Levene's test. In doing so we compare the happiness scores variance of the 'low','mid' and 'high' sophistication group for each of the 15 songs. If the test shows a significant p-value, at least one of the groups has a different variance than the others. To see exactly what group has this different variance and visualize the data, we plot the happiness score distribution for each sophistication group using a boxplot. If our prediction was supported by the data, then the dark green box (i.e. variance of the highly sophisticated participants) would be systematically smaller than the lighter green boxes (i.e. variance of the 'mid' and 'low' participants). As a final note, Levene's test's p-values are corrected for multiplied testing using Bonferroni's correction.

### Analysis
As we can see from the corrected Levene's tests p-value, none of the songs groups have different variances. From visual inspection we can also see that the dark green box does not tend to be smaller than the other two.

### Considerations
It could be the case that our sample has a low sophistication in general. This would mean that our 'high' group still has a low sophistication in absolute terms, and thus we are not able to infer anything about highly sophisticated people and variance in happiness scores. To check this we plot the music sophistication distribution in our sample. We can see here nevertheless, that sophistication levels are sufficiently spread and we can consider our sample representative enough.

Conclusion
=======================================================================

Row
-------------------------------------
### Valence is a valid proxy for happiness, however not perfect

In the existing literature, Spotify’s valence measure has often been used as a way to operationalize the happiness of a track or playlist. Given that our study found valence to significantly predict subjective happiness ratings, this practice seems to be valid. It should be noted however, that not all of the happiness’ variance was explained by valence (R²=0.12). Future research may therefore combine several of Spotify’s other features such as valence but also danceability or mode, assign weights to them and use this compound of features as a more accurate representation of happiness in music.

### Distribution of valences for songs rated at different happiness level {data-width=260}

```{r}
reg_ds%>% 
  ggplot(aes(factor(hppy), valence))+ 
  geom_boxplot(fill = '#1DB954')+
  xlab('Happiness rating')+
  ylab('Song valence')+
  labs(title = 'Songs rated as happier tend to have a higher valence',
       subtitle = 'Distribution of valences for songs rated at different happiness level')+
  theme_minimal()+
  theme(plot.title = element_text(face = 2),
        panel.grid.major.x = element_blank())
```

Row
-------------------------------------
### The musical sophistication measured by the Gold-MSI does not seem to include the ability to judge happiness in music.

According to its authors, the Goldsmith-MSI is an instrument measuring “self-reported musical skills and behaviours” (Müllensiefen et al., 2014). In our study, a participant’s musical sophistication was not found to significantly strengthen the relationship between a song’s valence and the subjective happiness perceived by people listening to it. Thus, judging happiness in music is either not included in the skills and behaviours captured by the Gold-MSI or self-reported musical sophistication does not match actual performance, in our case judging the happiness of songs. In the above-mentioned original study presenting the Goldsmith-MSI, the authors validate it by demonstrating a positive association between musical sophistication and performances on melodic memory and beat perception tasks respectively. One common feature of those two tasks is that the measured aspect, whether melody or beat, is objective and precisely definable. This is not the case with happiness, which is a quality of a track that is more intangible and lies a lot more in the eyes (or rather ears) of the beholder. Thus, the Goldsmith-MSI seems to be more adequate when measuring people’s abilities to judge objective aspects of music, rather than intangibles such as happiness.

### Valence distributions at each level of happiness by sophistication levels {data-width=260}

```{r}


low <- sort(sphst$sophi)[1:(length(sphst$sophi)*(1/3))]
mid <- sort(sphst$sophi)[(length(sphst$sophi)*(1/3)+1):(length(sphst$sophi)*(2/3))]
high <- sort(sphst$sophi)[(length(sphst$sophi)*(2/3)+1):(length(sphst$sophi))]

#make data set 
plot_ds <- stats_ds%>%
  pivot_longer(song1:song15)%>%
  select(ResponseId,song = name, hppy = value)%>%
  inner_join(vlncs)%>%
  inner_join(sphst)%>%
  mutate(grp = ifelse(sophi %in% low, 1,2))%>%
  mutate(grp = ifelse(sophi %in% high,3,grp))%>%
  mutate(grp = as.factor(grp))

levels(plot_ds$grp) <- c('Low','Mid','High')

ggplot(plot_ds,aes(x=factor(hppy),y=valence,fill = grp))+
  geom_boxplot()+
  facet_grid(.~grp)+
  xlab(label = 'Happiness scores')+
  ylab(label = ifelse(i == 1,'Valence',''))+
  theme_minimal()+
  theme(plot.title = element_text(face="bold"))+
  theme(legend.position =  'none',
        panel.grid.major.x = element_blank())+
  scale_fill_manual(values = c('Low' = "#c5f6d6",'Mid' = "#83eca7",'High' = "#1db954"))+
  labs(title = 'Sophistication has no moderation effect', subtitle = 'Valence distributions at each level of happiness by sophistication levels')
```

Row
-------------------------------------
### People with a higher musical sophistication do not ‘agree more’ in their judgement of music happiness.

In Hypothesis 3 we tested to what extent the more sophisticated participants showed less spreaded answers (i.e. if the variance in their response was smaller). If this was the case, it pointed at more sophisticated participants ‘agreeing more’ in their answers. So even if they did not agree with the Spotify valence more than less sophisticated participants, they did agree among themselves. This prediction stems from the fact that more sophisticated participants indeed ‘agree more’ than less sophisticated ones when, for instance, judging the pitch of sound. Nevertheless, we found no sign of greater agreement in any of the 15 songs. This could have been explained by our sample lacking a good representation of more musically sophisticated people. It could have been the case that, out of chance or due to sampling bias, our participants were all rather unsophisticated in absolute terms. Nonetheless, after comparing our distribution to that from the original paper that introduced the Goldsmith-MSI questionnaire, this explanation is ruled out. In sum, our data clearly points at sophisticated people not showing a higher agreement in their happiness judgment. 

### Happiness perception by musical sophistication {data-width=260}

```{r}
#calculate levene's test and make plots

songs <- unique(var_ds$song)
plot <- list()

for(i in 1:15){
  song <- var_ds%>%
    subset(song == songs[i])
  lev_p <- p.adjust(car::leveneTest(song$hppy,song$grp)$`Pr(>F)`[1],'bonferroni',15) #we correct for multiple testing
  plot[[i]] <- ggplot(song,aes(grp,hppy,fill = grp))+
    geom_boxplot()+  
    ggtitle(paste(c('   Song ',i),collapse = ''))+
    scale_x_discrete(labels = c('low','mid','high'))+
    xlab(ifelse(i %in% 11:15,'sophistication',''))+
    ylab(ifelse(i %in% c(1,6,11),'happiness',''))+
    theme(plot.title = element_text(face="bold"))+
    scale_fill_manual(values = c('1' = "#c5f6d6",
                                 '2' = "#83eca7",
                                 '3' = "#1db954"))+
    theme_minimal()+
    theme(legend.position = 'none')+
    scale_y_continuous(breaks = seq(1,7,by = 1))+
    ylim(1,7)
  }

gridExtra::grid.arrange(plot[[1]],plot[[2]],plot[[3]],plot[[4]],plot[[5]],plot[[6]],plot[[7]],
                        plot[[8]],plot[[9]],plot[[10]],plot[[11]],plot[[12]],plot[[13]],
                        plot[[14]],plot[[15]],nrow = 3)
```
